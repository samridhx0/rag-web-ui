<!DOCTYPE html>
<html lang="en" class="h-full bg-zinc-950 text-zinc-100 antialiased selection:bg-indigo-600/80">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG Document Q&A</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: { 500: '#6366f1', 600: '#4f46e5' },
            },
            fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          },
        },
      };
    </script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Markdown renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Hero icons -->
    <script src="https://unpkg.com/feather-icons"></script>
  </head>

  <body class="flex flex-col min-h-full">
    <!-- ── Hero ─────────────────────────────────────────────────── -->
    <section class="relative isolate overflow-hidden bg-zinc-900 py-20">
      <svg class="absolute inset-0 -z-10 h-full w-full" aria-hidden="true">
        <defs>
          <radialGradient id="bgGradient" cx="50%" cy="50%" r="75%">
            <stop offset="0%" stop-color="#5b5be4" stop-opacity=".3" />
            <stop offset="100%" stop-color="#000000" stop-opacity="0" />
          </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#bgGradient)" />
      </svg>

      <div class="max-w-4xl px-6 lg:px-8 mx-auto text-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
          RAG Document Q&A
        </h1>
        <p class="mt-4 text-lg text-zinc-400">
          Upload a document, ask questions, get context-aware answers.
        </p>
      </div>
    </section>

    <!-- ── Main content wrapper ─────────────────────────────────── -->
    <main class="flex-1 w-full max-w-4xl mx-auto px-4 sm:px-8 py-10 flex flex-col gap-10">

      <!-- Upload Card -->
      <section class="rounded-3xl border border-zinc-800 bg-zinc-900/60 backdrop-blur-md shadow-xl shadow-black/30">
        <div class="p-6 sm:p-8">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-feather="upload" class="w-5 h-5 text-primary-500"></i>
            Upload Document
          </h2>

          <div
            id="dropZone"
            class="relative mt-6 flex flex-col items-center justify-center rounded-2xl border-2 border-dashed border-zinc-700 p-10 transition-colors">
            <input
              id="fileInput"
              type="file"
              accept=".txt,.pdf,.csv,.json,.docx,.doc,.md"
              class="absolute inset-0 cursor-pointer opacity-0"
            />
            <i data-feather="file-plus" class="h-14 w-14 text-zinc-500 mb-4 transition-transform duration-200" id="dropIcon"></i>
            <p class="text-sm text-zinc-400">
              Drag & drop a
              <span class="font-medium text-zinc-100">.txt, .pdf, .csv, .json, .docx, .doc,</span> or
              <span class="font-medium text-zinc-100">.md</span> file here, or
              <span class="underline">click to browse</span>.
            </p>

            <div class="w-full h-2 bg-zinc-800 rounded mt-6 invisible" id="progressWrap">
              <div id="progressBar" class="h-2 bg-primary-500 rounded" style="width:0%"></div>
            </div>
          </div>

          <p id="uploadStatus" class="mt-4 text-sm text-zinc-400 hidden"></p>
        </div>
      </section>

      <!-- Q&A Card -->
      <section class="rounded-3xl border border-zinc-800 bg-zinc-900/60 backdrop-blur-md shadow-xl shadow-black/30 flex flex-col">
        <div class="p-6 sm:p-8 flex-1 flex flex-col">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-feather="message-circle" class="w-5 h-5 text-primary-500"></i>
            Ask a Question
          </h2>

          <div class="mt-6 flex gap-3">
            <input
              id="questionInput"
              type="text"
              placeholder="Ask something…"
              class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800/70 px-4 py-2 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary-500"
            />
            <button
              id="askBtn"
              class="rounded-lg bg-primary-600 px-5 py-2 font-medium transition-colors hover:bg-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
              Ask
            </button>
          </div>

          <!-- Answer output -->
          <div id="answerBox" class="prose prose-invert max-w-none leading-relaxed mt-6 hidden"></div>

          <!-- Copy & sources -->
          <div class="flex items-center gap-4 mt-4 hidden" id="answerMeta">
            <button
              id="copyBtn"
              class="rounded bg-zinc-800 px-3 py-1 text-xs hover:bg-zinc-700 transition-colors">
              Copy
            </button>
            <details>
              <summary class="cursor-pointer text-xs text-primary-400">Sources</summary>
              <ul id="sourceList" class="ml-6 mt-2 list-disc text-xs"></ul>
            </details>
          </div>
        </div>
      </section>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 select-none pointer-events-none opacity-0 transition"></div>

    <!-- Theme Toggle -->
    <button
      id="themeToggle"
      class="fixed bottom-6 right-6 rounded-full bg-zinc-800 p-3 shadow-md shadow-black/20 backdrop-blur hover:bg-zinc-700 transition">
      <i id="themeIcon" data-feather="sun" class="w-5 h-5"></i>
    </button>

    <!-- ── Scripts ──────────────────────────────────────────────── -->
    <script>
      /* === Config === */
      const backendURL = "https://rag-web-app.onrender.com";

      /* === Elements === */
      const dropZone      = document.getElementById('dropZone');
      const fileInput     = document.getElementById('fileInput');
      const progressWrap  = document.getElementById('progressWrap');
      const progressBar   = document.getElementById('progressBar');
      const uploadStatus  = document.getElementById('uploadStatus');
      const questionInput = document.getElementById('questionInput');
      const askBtn        = document.getElementById('askBtn');
      const answerBox     = document.getElementById('answerBox');
      const answerMeta    = document.getElementById('answerMeta');
      const copyBtn       = document.getElementById('copyBtn');
      const sourceList    = document.getElementById('sourceList');
      const toast         = document.getElementById('toast');
      const dropIcon      = document.getElementById('dropIcon');

      /* === State === */
      let documentId = null;

      /* === Toast util === */
      function showToast(msg, variant = 'neutral') {
        toast.textContent = msg;
        toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 pointer-events-none px-5 py-3 rounded-lg shadow-lg transition';
        const colorMap = { success: 'bg-emerald-600', error: 'bg-rose-600', neutral: 'bg-zinc-800' };
        toast.classList.add(colorMap[variant]);
        toast.style.opacity = '1';
        setTimeout(() => (toast.style.opacity = '0'), 3000);
      }

      /* === Drag animations === */
      ['dragenter', 'dragover'].forEach(evt =>
        dropZone.addEventListener(evt, e => {
          e.preventDefault();
          dropZone.classList.add('border-primary-500');
          dropIcon.classList.add('animate-bounce');
        })
      );
      ['dragleave', 'drop'].forEach(evt =>
        dropZone.addEventListener(evt, e => {
          dropZone.classList.remove('border-primary-500');
          dropIcon.classList.remove('animate-bounce');
        })
      );
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleUpload();
        }
      });
      fileInput.addEventListener('change', handleUpload);

      /* === Upload logic === */
      function handleUpload() {
        const file = fileInput.files[0];
        if (!file) return;

        progressWrap.classList.remove('invisible');
        progressBar.style.width = '0%';
        uploadStatus.classList.remove('hidden');
        uploadStatus.textContent = `Uploading: ${file.name}`;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${backendURL}/upload`);
        xhr.upload.onprogress = e => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressBar.style.width = percent.toFixed(1) + '%';
          }
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            const json = JSON.parse(xhr.responseText);
            documentId = json.document_id;
            uploadStatus.textContent = `✅ Processed (${json.chunks_created} chunks)`;
            showToast('File processed', 'success');
          } else {
            const err = JSON.parse(xhr.responseText).error || 'Upload failed';
            uploadStatus.textContent = '❌ Upload failed';
            showToast(err, 'error');
          }
        };
        xhr.onerror = () => {
          uploadStatus.textContent = '❌ Upload failed';
          showToast('Upload failed', 'error');
        };
        const form = new FormData();
        form.append('file', file);
        xhr.send(form);
      }

      /* === Query logic === */
      askBtn.addEventListener('click', queryDoc);
      questionInput.addEventListener('keydown', e => e.key === 'Enter' && queryDoc());

      async function queryDoc() {
        const q = questionInput.value.trim();
        if (!q) return;
        if (!documentId) return showToast('Upload a document first', 'error');

        askBtn.disabled = true;
        askBtn.textContent = '…';
        answerBox.classList.add('hidden');
        answerMeta.classList.add('hidden');

        try {
          const res = await fetch(`${backendURL}/query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: q })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Query failed');

          answerBox.innerHTML = marked.parse(data.answer || '');
          answerBox.classList.remove('hidden');

          if (data.sources && data.sources.length) {
            sourceList.innerHTML = data.sources.map(s => `<li>${s}</li>`).join('');
            answerMeta.classList.remove('hidden');
          }

        } catch (err) {
          showToast(err.message || 'Query failed', 'error');
        } finally {
          askBtn.disabled = false;
          askBtn.textContent = 'Ask';
        }
      }

      /* === Copy answer === */
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(answerBox.textContent).then(() => showToast('Copied!', 'success'));
      });

      /* === Theme toggle === */
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon   = document.getElementById('themeIcon');
      const storedTheme = localStorage.getItem('theme') || 'system';

      const applyTheme = mode => {
        const root = document.documentElement;
        if (mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches))
          root.classList.add('dark');
        else root.classList.remove('dark');
        themeIcon.setAttribute('data-feather', root.classList.contains('dark') ? 'sun' : 'moon');
        feather.replace();
      };
      applyTheme(storedTheme);

      themeToggle.addEventListener('click', () => {
        const current = localStorage.getItem('theme') || 'system';
        const next = current === 'light' ? 'dark' : current === 'dark' ? 'system' : 'light';
        localStorage.setItem('theme', next);
        applyTheme(next);
      });

      /* Feather icon refresh */
      feather.replace();
    </script>
  </body>
</html>
